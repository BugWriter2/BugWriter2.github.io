<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Awaitable | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json"><link rel='canonical' href='https://bugwriter2.github.io/python/Coroutine.html'/>
    <meta name="description" content="博客">
    <meta name="google-site-verification" content="PXbr-y9acmnnEmw1zgCFEydL32xlZIf1OfFmzDFUrzI">
    <link rel="preload" href="/assets/css/0.styles.9ce6ac63.css" as="style"><link rel="preload" href="/assets/js/app.3fa2a2e1.js" as="script"><link rel="preload" href="/assets/js/2.057925ea.js" as="script"><link rel="preload" href="/assets/js/30.540536d8.js" as="script"><link rel="prefetch" href="/assets/js/10.9a53695e.js"><link rel="prefetch" href="/assets/js/11.e6f60bd9.js"><link rel="prefetch" href="/assets/js/12.90f3d785.js"><link rel="prefetch" href="/assets/js/13.42e681ed.js"><link rel="prefetch" href="/assets/js/14.7a85d7cd.js"><link rel="prefetch" href="/assets/js/15.402110d9.js"><link rel="prefetch" href="/assets/js/16.776ab4c1.js"><link rel="prefetch" href="/assets/js/17.4af5340c.js"><link rel="prefetch" href="/assets/js/18.bd060f5e.js"><link rel="prefetch" href="/assets/js/19.ac40939f.js"><link rel="prefetch" href="/assets/js/20.ac68ccd2.js"><link rel="prefetch" href="/assets/js/21.90d4b479.js"><link rel="prefetch" href="/assets/js/22.044d8e2b.js"><link rel="prefetch" href="/assets/js/23.606676bb.js"><link rel="prefetch" href="/assets/js/24.e8a14162.js"><link rel="prefetch" href="/assets/js/25.ebdc5e35.js"><link rel="prefetch" href="/assets/js/26.efd6b8fb.js"><link rel="prefetch" href="/assets/js/27.649d5e23.js"><link rel="prefetch" href="/assets/js/28.1c7ccf18.js"><link rel="prefetch" href="/assets/js/29.f0ca98d8.js"><link rel="prefetch" href="/assets/js/3.7c0ca1fc.js"><link rel="prefetch" href="/assets/js/31.3cc7b8a3.js"><link rel="prefetch" href="/assets/js/32.02879a8f.js"><link rel="prefetch" href="/assets/js/33.b1417b92.js"><link rel="prefetch" href="/assets/js/34.0b5079cd.js"><link rel="prefetch" href="/assets/js/35.2828b1d3.js"><link rel="prefetch" href="/assets/js/36.d0d0971a.js"><link rel="prefetch" href="/assets/js/37.6cc365c3.js"><link rel="prefetch" href="/assets/js/38.a184b552.js"><link rel="prefetch" href="/assets/js/39.84a689f9.js"><link rel="prefetch" href="/assets/js/4.7a06b201.js"><link rel="prefetch" href="/assets/js/40.c2d886c6.js"><link rel="prefetch" href="/assets/js/5.0de0ba0e.js"><link rel="prefetch" href="/assets/js/6.cb2a4e71.js"><link rel="prefetch" href="/assets/js/7.f7f97492.js"><link rel="prefetch" href="/assets/js/8.7c626f1f.js"><link rel="prefetch" href="/assets/js/9.b014d1e7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9ce6ac63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link router-link-active">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link router-link-active">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/python/Basics.html" class="sidebar-link">Basics</a></li><li><a href="/python/Web.html" class="sidebar-link">Web</a></li><li><a href="/python/NN.html" class="sidebar-link">Neural Networks</a></li><li><a href="/python/Test.html" class="sidebar-link">Test</a></li><li><a href="/python/PDF.html" class="sidebar-link">PDF</a></li><li><a href="/python/Coroutine.html" aria-current="page" class="active sidebar-link">Awaitable</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/Coroutine.html#task-cancellation" class="sidebar-link">Task Cancellation</a></li><li class="sidebar-sub-header"><a href="/python/Coroutine.html#circular-await" class="sidebar-link">Circular await</a></li><li class="sidebar-sub-header"><a href="/python/Coroutine.html#contextvars" class="sidebar-link">ContextVars</a></li><li class="sidebar-sub-header"><a href="/python/Coroutine.html#concurrent-futures-integration" class="sidebar-link">Concurrent.futures integration</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="awaitable"><a href="#awaitable" class="header-anchor">#</a> Awaitable</h1> <p>Three <code>awaitables</code>:</p> <ul><li><code>coroutine</code>: <code>async def</code></li> <li><code>Task</code>: schedule a <code>coroutine</code> run in the same thread</li> <li><code>Future</code>: schedule to run somewhere(same thread, another thread or process); parent class of <code>Task</code> to mimic <code>concurrent.futures.Future</code> in synchronous programming</li></ul> <h2 id="task-cancellation"><a href="#task-cancellation" class="header-anchor">#</a> Task Cancellation</h2> <p><code>asyncio.gather</code></p> <ol><li>bare gather + cancel, wrapped coroutine not running at all</li> <li>after cancel if no await on gather =&gt; GatheringFuture exception was never retrieved</li></ol> <p>Examples:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> datetime

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">keep_printing</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ah cancelled!'</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main_no_await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    group_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;First&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Third&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    group_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main_no_await_cancel_later</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    group_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;First&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Third&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    group_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main_await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    group_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;First&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        keep_printing<span class="token punctuation">(</span><span class="token string">&quot;Third&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    group_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> group_task

<span class="token triple-quoted-string string">&quot;&quot;&quot;
1. keep_printing not running at all
2. _GatheringFuture exception was never retrieved
&quot;&quot;&quot;</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main_no_await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
1. _GatheringFuture exception was never retrieved
&quot;&quot;&quot;</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main_no_await_cancel_later<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
1. CancelledError thrown
&quot;&quot;&quot;</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main_await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>asyncio.Task</code></p> <p>Calling <code>cancel</code> will cause the Task to throw a CancelledError exception into the wrapped coroutine. If a coroutine is awaiting on a Future object during cancellation, the Future object will be cancelled(joint liability).</p> <p>Note that if the original cancelling task is not awaited, then <code>CancelledError</code> will not be thrown. Its wrapped coroutine throws <code>CancelledError</code> as usual, but this exception is not propagated to the original un-awaited task</p> <div class="custom-block tip"><p class="custom-block-title">auto cancel</p> <p>After loop close, running task will also be cancelled</p></div> <p>Examples:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">small_task</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> small_task(): cancel sleep'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">cancel_me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>small_task<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>small_task<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> t1
    <span class="token keyword">await</span> t2

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main_no_await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>cancel_me<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main_await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>cancel_me<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
1. wrapped coroutine cancelled as usual, but main_no_await no exception thrown
2. t2 is cancelled at program end
&quot;&quot;&quot;</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main_no_await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
1. main_await throws CancelledError
2. t2 is cancelled at program end
&quot;&quot;&quot;</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main_await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>References:</p> <ol><li><a href="https://github.com/python/cpython/issues/80637" target="_blank" rel="noopener noreferrer">python issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li></li></ol> <h2 id="circular-await"><a href="#circular-await" class="header-anchor">#</a> Circular await</h2> <p>Maximum recursion exception thrown due to f cancels g which cancels f which cancels g...</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> g_task

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> f_task

    f_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    g_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>g<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        f_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>f_task<span class="token punctuation">,</span> g_task<span class="token punctuation">,</span> release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Coroutine returns error immediately saying coroutine cannot await on itself</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">unit_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_name <span class="token operator">==</span> <span class="token string">'main'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_name<span class="token punctuation">,</span> task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_filename<span class="token punctuation">,</span> <span class="token string">'unit'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
            <span class="token keyword">await</span> task

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">recursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> unit_task<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> recursion<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Tasks hangs, and if interrupted, maximum recursion error happens at program end</p> <div class="language-python extra-class"><pre class="language-python"><code>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">unit_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_name <span class="token operator">==</span> <span class="token string">'main'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_name<span class="token punctuation">,</span> task<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>cr_code<span class="token punctuation">.</span>co_filename<span class="token punctuation">,</span> <span class="token string">'unit'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span>
            <span class="token keyword">await</span> task

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">recursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>unit_task<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> t2

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>recursion<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> t1


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="contextvars"><a href="#contextvars" class="header-anchor">#</a> ContextVars</h2> <p>When a new Task is created from coroutine, the context is copied</p> <h2 id="concurrent-futures-integration"><a href="#concurrent-futures-integration" class="header-anchor">#</a> Concurrent.futures integration</h2> <p>ProcessPoolExecutor</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">cpu_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># CPU-bound operations will block the event loop:</span>
    <span class="token comment"># in general it is preferable to run them in a</span>
    <span class="token comment"># process pool.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>i <span class="token operator">*</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">**</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


event_loops_for_each_process<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> AbstractEventLoop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">dispatch_coroutines</span><span class="token punctuation">(</span>corofn<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    curr_pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> curr_pid <span class="token keyword">not</span> <span class="token keyword">in</span> event_loops_for_each_process<span class="token punctuation">:</span>
        event_loops_for_each_process<span class="token punctuation">[</span>curr_pid<span class="token punctuation">]</span> <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    process_loop <span class="token operator">=</span> event_loops_for_each_process<span class="token punctuation">[</span>curr_pid<span class="token punctuation">]</span>
    coro <span class="token operator">=</span> corofn<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> process_loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_gather_tasks</span><span class="token punctuation">(</span>all_tasks<span class="token punctuation">:</span> Set<span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>all_tasks<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">wait_loops</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    curr_pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    processes_event_loop <span class="token operator">=</span> event_loops_for_each_process<span class="token punctuation">[</span>curr_pid<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Process </span><span class="token interpolation"><span class="token punctuation">{</span>curr_pid<span class="token punctuation">}</span></span><span class="token string"> will wait its tasks.'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> processes_event_loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>async_gather_tasks<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span>processes_event_loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Dispatch tasks once and let each worker wait for a batch of tasks to finish, rather than waiting for one task at a time for each worker
    &quot;&quot;&quot;</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ProcessPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
        <span class="token comment"># dispatch first</span>
        <span class="token comment"># each worker contains a batch of tasks</span>
        futures <span class="token operator">=</span> <span class="token punctuation">[</span>
            loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>pool<span class="token punctuation">,</span> dispatch_coroutines<span class="token punctuation">,</span> cpu_bound<span class="token punctuation">)</span><span class="token punctuation">,</span>
            loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>pool<span class="token punctuation">,</span> dispatch_coroutines<span class="token punctuation">,</span> cpu_bound<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>futures<span class="token punctuation">)</span>
        futures <span class="token operator">=</span> <span class="token punctuation">[</span>loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>pool<span class="token punctuation">,</span> wait_loops<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment"># each worker execute and wait its own tasks</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>futures<span class="token punctuation">)</span>

<span class="token comment"># if __name__ == '__main__' is a must on windows</span>
<span class="token comment"># reason: https://stackoverflow.com/a/20222706</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>ThreadPoolExecutor</p> <div class="language-python extra-class"><pre class="language-python"><code>mport asyncio
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> asyncio <span class="token keyword">import</span> AbstractEventLoop
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">from</span> time <span class="token keyword">import</span> perf_counter
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Set

event_loops_for_each_thread<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> AbstractEventLoop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">dispatch_coroutines</span><span class="token punctuation">(</span>corofn<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    curr_thread_id <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_native_id<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> curr_thread_id <span class="token keyword">not</span> <span class="token keyword">in</span> event_loops_for_each_thread<span class="token punctuation">:</span>
        event_loops_for_each_thread<span class="token punctuation">[</span>curr_thread_id<span class="token punctuation">]</span> <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

    thread_loop <span class="token operator">=</span> event_loops_for_each_thread<span class="token punctuation">[</span>curr_thread_id<span class="token punctuation">]</span>
    coro <span class="token operator">=</span> corofn<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> thread_loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_gather_tasks</span><span class="token punctuation">(</span>all_tasks<span class="token punctuation">:</span> Set<span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>all_tasks<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">wait_loops</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    curr_thread_id <span class="token operator">=</span> threading<span class="token punctuation">.</span>get_native_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
    threads_event_loop <span class="token operator">=</span> event_loops_for_each_thread<span class="token punctuation">[</span>curr_thread_id<span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Thread </span><span class="token interpolation"><span class="token punctuation">{</span>curr_thread_id<span class="token punctuation">}</span></span><span class="token string"> will wait its tasks.'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> threads_event_loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>async_gather_tasks<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span>threads_event_loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    max_workers <span class="token operator">=</span> <span class="token number">5</span>
    executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>max_workers<span class="token punctuation">)</span>
    futures <span class="token operator">=</span> <span class="token punctuation">[</span>
        loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>executor<span class="token punctuation">,</span> dispatch_coroutines<span class="token punctuation">,</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>futures<span class="token punctuation">)</span>
    futures <span class="token operator">=</span> <span class="token punctuation">[</span>
        loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>executor<span class="token punctuation">,</span> wait_loops<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_workers<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>futures<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    start <span class="token operator">=</span> perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    duration_s <span class="token operator">=</span> end <span class="token operator">-</span> start
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'duration_s=</span><span class="token interpolation"><span class="token punctuation">{</span>duration_s<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><p>Caveat:</p> <ol><li><code>loop.run_in_executor</code> accepts sync function only</li> <li>use <code>threading.get_native_id()</code> to identify threads while <code>os.getpid()</code> to distinguish between processes</li></ol> <p>Reference</p> <ol><li><a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.run_in_executor" target="_blank" rel="noopener noreferrer"><code>loop.run_in_executor</code> python docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://stackoverflow.com/questions/46074841/why-coroutines-cannot-be-used-with-run-in-executor#comment111589792_46075571" target="_blank" rel="noopener noreferrer">Use coroutine with run_in_executor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/1/2024, 4:22:58 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/PDF.html" class="prev">
        PDF
      </a></span> <!----></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3fa2a2e1.js" defer></script><script src="/assets/js/2.057925ea.js" defer></script><script src="/assets/js/30.540536d8.js" defer></script>
  </body>
</html>
