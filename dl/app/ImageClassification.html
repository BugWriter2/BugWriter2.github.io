<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Image Classification | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json"><link rel='canonical' href='https://bugwriter2.github.io/dl/app/ImageClassification.html'/>
    <meta name="description" content="博客">
    <meta name="google-site-verification" content="PXbr-y9acmnnEmw1zgCFEydL32xlZIf1OfFmzDFUrzI">
    <link rel="preload" href="/assets/css/0.styles.9ce6ac63.css" as="style"><link rel="preload" href="/assets/js/app.3fa2a2e1.js" as="script"><link rel="preload" href="/assets/js/2.057925ea.js" as="script"><link rel="preload" href="/assets/js/15.402110d9.js" as="script"><link rel="prefetch" href="/assets/js/10.9a53695e.js"><link rel="prefetch" href="/assets/js/11.e6f60bd9.js"><link rel="prefetch" href="/assets/js/12.90f3d785.js"><link rel="prefetch" href="/assets/js/13.42e681ed.js"><link rel="prefetch" href="/assets/js/14.7a85d7cd.js"><link rel="prefetch" href="/assets/js/16.776ab4c1.js"><link rel="prefetch" href="/assets/js/17.4af5340c.js"><link rel="prefetch" href="/assets/js/18.bd060f5e.js"><link rel="prefetch" href="/assets/js/19.ac40939f.js"><link rel="prefetch" href="/assets/js/20.ac68ccd2.js"><link rel="prefetch" href="/assets/js/21.90d4b479.js"><link rel="prefetch" href="/assets/js/22.044d8e2b.js"><link rel="prefetch" href="/assets/js/23.606676bb.js"><link rel="prefetch" href="/assets/js/24.e8a14162.js"><link rel="prefetch" href="/assets/js/25.ebdc5e35.js"><link rel="prefetch" href="/assets/js/26.efd6b8fb.js"><link rel="prefetch" href="/assets/js/27.649d5e23.js"><link rel="prefetch" href="/assets/js/28.1c7ccf18.js"><link rel="prefetch" href="/assets/js/29.f0ca98d8.js"><link rel="prefetch" href="/assets/js/3.7c0ca1fc.js"><link rel="prefetch" href="/assets/js/30.540536d8.js"><link rel="prefetch" href="/assets/js/31.3cc7b8a3.js"><link rel="prefetch" href="/assets/js/32.02879a8f.js"><link rel="prefetch" href="/assets/js/33.b1417b92.js"><link rel="prefetch" href="/assets/js/34.0b5079cd.js"><link rel="prefetch" href="/assets/js/35.2828b1d3.js"><link rel="prefetch" href="/assets/js/36.d0d0971a.js"><link rel="prefetch" href="/assets/js/37.6cc365c3.js"><link rel="prefetch" href="/assets/js/38.a184b552.js"><link rel="prefetch" href="/assets/js/39.84a689f9.js"><link rel="prefetch" href="/assets/js/4.7a06b201.js"><link rel="prefetch" href="/assets/js/40.c2d886c6.js"><link rel="prefetch" href="/assets/js/5.0de0ba0e.js"><link rel="prefetch" href="/assets/js/6.cb2a4e71.js"><link rel="prefetch" href="/assets/js/7.f7f97492.js"><link rel="prefetch" href="/assets/js/8.7c626f1f.js"><link rel="prefetch" href="/assets/js/9.b014d1e7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9ce6ac63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link router-link-active">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link router-link-active">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Applications</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dl/app/ImageClassification.html" aria-current="page" class="active sidebar-link">Image Classification</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#cnn" class="sidebar-link">CNN</a></li><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#resnet" class="sidebar-link">ResNet</a></li><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#class-activation-map" class="sidebar-link">Class activation map</a></li><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#efficientnet" class="sidebar-link">EfficientNet</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#模型结构" class="sidebar-link">模型结构</a></li><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#复合缩放" class="sidebar-link">复合缩放</a></li></ul></li><li class="sidebar-sub-header"><a href="/dl/app/ImageClassification.html#efficientnet-preparation" class="sidebar-link">EfficientNet preparation</a></li></ul></li><li><a href="/dl/app/MachineTranslation.html" class="sidebar-link">Machine Translation</a></li><li><a href="/dl/app/TableRecognition.html" class="sidebar-link">Table Recognition</a></li></ul></section></li><li><a href="/dl/Optimizer.html" class="sidebar-link">Optimizer</a></li><li><a href="/dl/Loss.html" class="sidebar-link">Loss</a></li><li><a href="/dl/Backpropagation.html" class="sidebar-link">Backpropagation</a></li><li><a href="/dl/Pytorch.html" class="sidebar-link">Pytorch</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tensorflow</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="image-classification"><a href="#image-classification" class="header-anchor">#</a> Image Classification</h1> <h2 id="cnn"><a href="#cnn" class="header-anchor">#</a> CNN</h2> <p><strong>Parameter calculation</strong></p> <p><img src="https://cdn-images-1.medium.com/freeze/max/1000/0*vxqEUxcBMWsQtUem.png?q=20" alt="cnn"></p> <ul><li><code>input dimension</code>: (I_w, I_h, n_channel). When n_channel = 1, it is a 2D input</li> <li><code>kernel dimension</code>: (K, K, n_channel). Kernel is not always a square, it can be (K_w, K_h, n_channel)</li> <li><code>output size</code>:
<img src="https://latex.codecogs.com/gif.latex?O%3D%5Cfrac%7BI-K+2%20P%7D%7BS%7D+1" alt="kernel"></li> <li><code>output dimension</code>: (O, O, output_channels)
<img src="https://cdn-images-1.medium.com/freeze/max/1000/0*EiMclEM0Yg9TF77g.jpg?q=20" alt="output"></li></ul> <p><strong>Ways of improving accuracy</strong></p> <ul><li>wider: increase number of output channels</li> <li>deeper: increase number of neural networks</li> <li>resolution larger: increase input size</li></ul> <h2 id="resnet"><a href="#resnet" class="header-anchor">#</a> ResNet</h2> <p><strong>conv1x1</strong></p> <ul><li>Dimensionality reduction/augmentation</li> <li>Reduce computational load by reducing parameter map</li> <li>Add non-linearity (RELU)</li></ul> <p><img src="https://miro.medium.com/max/700/1*dNaikOfrGzUaJ2EzRIl4tw.png" alt="conv"></p> <p><img src="https://miro.medium.com/max/700/1*3kgQ1HJvVOGK_LWS_ANoBA.png" alt="conv1"> <img src="https://miro.medium.com/max/700/1*C2ei51Og0WMpoEesMFEvcA.png" alt="conv2"></p> <p><strong>Batch normalization</strong></p> <p><img src="https://latex.codecogs.com/gif.latex?O_%7Bb%2C%20c%2C%20x%2C%20y%7D%20%5Cleftarrow%20%5Cgamma_%7Bc%7D%20%5Cfrac%7BI_%7Bb%2C%20c%2C%20x%2C%20y%7D-%5Cmu_%7Bc%7D%7D%7B%5Csqrt%7B%5Csigma_%7Bc%7D%5E%7B2%7D+%5Cepsilon%7D%7D+%5Cbeta_%7Bc%7D%20%5Cquad%20%5Cforall%20b%2C%20c%2C%20x%2C%20y" alt="bn"></p> <ul><li><code>I</code>: input</li> <li><code>O</code>: output</li> <li><code>b,c,x,y</code>: batch, channel, width, height</li> <li><code>u, sigma</code>:
<ul><li>if training, computed from batch</li> <li>if testing,
<ul><li>using average of whole training set</li> <li>a moving average calculated during training by: <code>running = 0.1*running + 0.9 * sample</code></li></ul></li></ul></li></ul> <p>Origin</p> <ul><li><p>deeper is better:</p> <ul><li>but gradient vanishing or exploding when layer is deeper[the input x is one of the term of gradient chain]</li> <li>but poor activations like <a href="https://ml-cheatsheet.readthedocs.io/en/latest/activation_functions.html#sigmoid" target="_blank" rel="noopener noreferrer">sigmoid<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li>gradient vanishing: at some time when intermediate input too large or too small</li> <li>gradient vanishing: derivative is at most 0.25, the front layer's gradient is chain product of later ones, some 0.1s' product goes to 0 very quickly [to alleviate, use modified version: <code>1 / (1 + exp(-ax))</code> with larger <code>a</code>]</li></ul></li> <li>but poor activations like <a href="https://ml-cheatsheet.readthedocs.io/en/latest/activation_functions.html#tanh" target="_blank" rel="noopener noreferrer">tanh<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> [gradient vanishing at some time when intermediate input too large or too small]:</li> <li>but poor activations like <a href="https://ml-cheatsheet.readthedocs.io/en/latest/activation_functions.html#relu" target="_blank" rel="noopener noreferrer">relu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li>gradient vanishing: negative [to alleviate, use LeakyReLU, but lose some non-linearity]</li> <li>gradient exploding: positive, return 1 and by multiplying other terms in gradient chain, boom!</li></ul></li></ul> <p><img src="https://i.stack.imgur.com/gMpB4.png" alt="activation"></p></li> <li><p>weight initialization matters:</p> <ul><li>random normalization or uniform, weight cannot be too small or too large, thus <strong>each output's variance should keep the same</strong> <ul><li>weight too large(then input too large) =&gt; relu is okay, but others produce vanishing gradient</li> <li>weight too small(then input too small) =&gt; all produce vanishing gradient [1. intrinsic reasons; 2. small x in a term in gradient chain]</li></ul></li> <li><a href="https://zhuanlan.zhihu.com/p/64464584" target="_blank" rel="noopener noreferrer">xavier + tanh, he + relu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li><strong>variance is not strictly the same</strong>, but better</li> <li>complexity of finding optima increases =&gt; convergence is slower, and <strong>learning rate should be small</strong></li></ul></li></ul></li> <li><p>larger learning rate is preferred:</p> <ul><li>faster convergence</li> <li>less likely to get stuck in sub minima</li> <li>error term's mean is 0(gradient is linear form of x), and variance is bounded by learning rate. Larger lr adds more noise.
<img src="https://latex.codecogs.com/gif.latex?%5Calpha%20%5Cnabla_%7BS%20G%20D%7D%28x%29%3D%5Cunderbrace%7B%5Calpha%20%5Cnabla%20%5Cell%28x%29%7D_%7B%5Ctext%20%7Bgradient%20%7D%7D+%5Cunderbrace%7B%5Cfrac%7B%5Calpha%7D%7B%7CB%7C%7D%20%5Csum_%7Bi%20%5Cin%20B%7D%5Cleft%28%5Cnabla%20%5Cell_%7Bi%7D%28x%29-%5Cnabla%20%5Cell%28x%29%5Cright%29%7D_%7B%5Ctext%20%7Berror%20lerm%20%7D%7D" alt="lr"></li></ul></li></ul> <p>batch normalization</p> <ul><li>better variance control than xavier and he</li> <li>normalizes the exploding weights
<ul><li>remove unimportant info in batch, height, width dimension as it normalizes in different channels</li> <li>less info results in faster convergence and simplicity in fitting</li></ul></li> <li>enables larger learning rate for better performance[convergence and optima]</li></ul> <div class="custom-block tip"><p class="custom-block-title">references</p> <ul><li><a href="https://papers.nips.cc/paper/7996-understanding-batch-normalization.pdf" target="_blank" rel="noopener noreferrer">Understanding Batch Normalization<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zhihu.com/question/326034346/answer/1251898824" target="_blank" rel="noopener noreferrer">Regularization<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <p><strong>Residual block + skip connection</strong></p> <ul><li>if input dimension the same as residual block's output dimension(left), the skip connection: <code>X_skip = X</code>, is a identity block</li> <li>otherwise(right), the skip connect block is a <code>conv1x1 + bn block</code></li> <li>skip connection mitigates vanishing gradient, as the input is forwarded</li> <li>there are many variants for residual blocks</li></ul> <p><img src="https://www.researchgate.net/profile/Antonio_Theophilo/publication/321347448/figure/fig2/AS:565869411815424@1511925189281/Bottleneck-Blocks-for-ResNet-50-left-identity-shortcut-right-projection-shortcut.png" alt="rb"></p> <p><img src="https://miro.medium.com/max/3368/1*8CwtKoYZsX9-VTDXbeKHAQ.png" alt="rb1"></p> <p><strong>5 stages</strong></p> <ul><li>1st stage: 3 paddings for up, bottom, right and left</li> <li>1st stage's max pooling: 1 paddings</li> <li>other padding options:
<ul><li><code>VALID</code>: no padding</li> <li><code>SAME</code>: evenly left and right, if the padding number is odd, the extra is put at the right to make input and output size the same (ignoring stride)</li></ul></li> <li>blue(2nd), yellow(3rd), pink(4th), green(5th)</li> <li>2nd to 5th stages uses <code>SAME</code> padding</li> <li>every blue, yellow, purple and green block below is a <code>residual block + skip connection</code></li> <li>from 2nd to 5th stages, every <code>residual block + skip connection</code> is repeated in some defined times (cfg)</li> <li>full line: skip connection uses identity block</li> <li>dotted line: skip connection uses conv1x1+bn block</li> <li>average pooling: 1x1</li> <li>112 =&gt; 56 =&gt; 28 =&gt; 14 =&gt; 7 =&gt; 2048 =&gt; 1000</li></ul> <p><img src="https://www.codeproject.com/KB/AI/1248963/resnet-r-700.png" alt="stages"></p> <p><img src="https://i.ibb.co/xGtSXPK/stage1.png" alt="stages1"></p> <p><img src="https://oncoml.io/wp-content/uploads/2020/01/resnet-101.png" alt="stages2"></p> <p><img src="https://i.ibb.co/nMrDfvm/output.png" alt="stages3"></p> <h2 id="class-activation-map"><a href="#class-activation-map" class="header-anchor">#</a> Class activation map</h2> <p>Global activation pooling:</p> <ul><li>regularization: reduce dimension, drop information and avoid overfitting</li> <li>localization</li></ul> <p><img src="https://alexisbcook.github.io/assets/global_average_pooling.png" alt="gap"></p> <p>Produce class activation map:</p> <ul><li>adds a gap between last conv and fc</li> <li>compute weighted linear sum
<ul><li><code>w</code> is from fc layer</li> <li><code>fk</code> is from conv layer's k kernel
<img src="https://latex.codecogs.com/gif.latex?S_%7Bc%7D%3D%5Csum_%7Bk%7D%20w_%7Bk%7D%5E%7Bc%7D%20%5Csum_%7Bx%2C%20y%7D%20f_%7Bk%7D%28x%2C%20y%29%3D%5Csum_%7Bx%2C%20y%7D%20%5Csum_%7Bk%7D%20w_%7Bk%7D%5E%7Bc%7D%20f_%7Bk%7D%28x%2C%20y%29" alt="wls"></li></ul></li></ul> <p><img src="https://miro.medium.com/max/700/0*Xs1rIupHWd8oD8m0.jpg" alt="cam"></p> <h2 id="efficientnet"><a href="#efficientnet" class="header-anchor">#</a> EfficientNet</h2> <h3 id="模型结构"><a href="#模型结构" class="header-anchor">#</a> 模型结构</h3> <p>图例：
<img src="https://i.ibb.co/fYxCLmH/en-ef0.png" alt="EfficientNet"> <img src="https://i.ibb.co/PZgLkjR/en-ef2.jpg" alt="EfficientNet"></p> <p>EfficientNet-B0结构图：
<img src="https://i.ibb.co/61TYSGD/en-ef1.jpg" alt="EfficientNet"></p> <ul><li><p>EfficientNet-B0是用强化学习的方式通过神经网络架构搜索设计得到的。学习时的优化目标为：</p> <img src="https://i.ibb.co/S7GDPXB/en-nas.png" width="400" style="display:block;margin:auto;"> <ul><li><code>T</code>: 目标计算量</li> <li><code>w</code>: -0.07，超参系数，用来衡量精度和计算量的权重。</li> <li><code>m</code>: 模型网络</li></ul></li> <li><p><strong><code>MBConv</code></strong>: <strong>移动翻转瓶颈卷积</strong> (Mobile inverted Bottleneck Convolution), 作为EfficientNet的核心模块，该模块是对其他卷积网络模型提出的各种模块的组装，其内部可拆分成4个子结构：</p> <ul><li><strong>深度可分离卷积</strong> (depthwise separable convolution), 该结构借鉴于Xception。该结构将原始的卷积操作分成了两步：<strong>深度卷积</strong> (depthwise convolution) 和 <strong>逐点卷积</strong> (pointwise convolution)。深度卷积时，核尺寸正常，但是一个卷积核 (kernel)只负责一个通道。逐点卷积的核尺寸是1x1，一个卷积核负责所有通道。与深度卷积相反，逐点卷积实现了跨通道信息的利用，两者结合使用之后实现了类似原始卷积操作的效果，并且大大减少了参数数量。</li> <li><strong>翻转残差</strong> (inverted residual block)，该子结构借鉴于MobileNetV2，通常与深度可分离卷积结合使用。残差模块会将输入和卷积结果进行跳越连接。原始的残差模块，例如ResNet中的模块，是两头通道维度大，中间通道维度小。 原始残差模块通过减少中间通道的维度来减少参数数量。翻转之后的模块首先对通道进行了<strong>扩展</strong> (expansion) 操作, 即对输入进行1x1的逐点卷积并根据扩展比例(expand ratio)改变输出通道维度（如扩展比例为3时，会将通道维度提升3倍。但如果扩展比例为1，则直接省略该1x1的逐点卷积和其之后批归一化和激活函数），因为后续进行深度卷积而不是原始卷积，所以参数并不多，因此通道维度并不需要减少，最后形成了两头通道维度小，中间通道维度大的结构。甚至由于深度卷积减少的参数过多，最后一次卷积时为了减少信息进一步损失， 翻转残差并没有启动激活函数。</li> <li><strong>压缩激发</strong> (squeeze and excitation block)，借鉴于SENet。该结构类似于<strong>注意力机制</strong>，通过特征图 (feature map) 为自身学习一个特征权值，通过单位乘的方式得到一组加权后的新的特征权值，以此来实现对每个通道赋予不同权重。</li> <li><strong>随机深度</strong> (stochastic depth), 借鉴于优化版的ResNet。深层网络学到的信息并不一定全部有效，因此很容易过拟合。于是一种dropout的思想在2012年由Hinton提出。Dropout时，会摒弃一些神经元的连接，减少神经元之间的相互作用。因为dropout是随机的，所以训练时还获得了很多版本的简化模型，最后预测时实现了多个简化模型的融合，提升了网络的泛化能力。随机深度与dropout类似，该结构会按一定概率跳过一整个残差模块，使网络获得随机深度，以此来缩短模型训练时间并且增强网络的泛化能力。</li></ul></li> <li><p><strong><code>Swish</code></strong>: 是谷歌大脑团队基于强化学习搜索到的非单调的激活函数，被证明在某些情况下比ReLU更优。</p> <img src="https://i.ibb.co/1rsYZSv/en-swish.jpg" width="400" style="display:block;margin:auto;"></li></ul> <h3 id="复合缩放"><a href="#复合缩放" class="header-anchor">#</a> 复合缩放</h3> <p>为了获得更好的精度，放大卷积神经网络是一种广泛的方法。然而，放大卷积神经网络的过程从来没有很好的理解过，目前通用的几种方法是放大卷积神经网络的深度、宽度和分辨率：</p> <ul><li><strong>宽度</strong>： 增加卷积网络的通道维度，更宽的网络能够捕获更细粒度的特征</li> <li><strong>深度</strong>：增加卷积网络的深度，即卷积层的数量。更深的网络可以捕获更丰富和更复杂的特征，但是由于梯度弥散、梯度爆炸等问题，训练难度也会增大。</li> <li><strong>分辨率</strong>：增加输入图片的分辨率，更清晰的图片往往会有更细粒度的特征</li></ul> <p>在之前都是单独放大这三个维度中的一个，但是单独放大某个维度很容易出现准确率饱和的情况，如下图所示：</p> <img src="https://i.ibb.co/ckMCC4Z/en-full.png" style="display:block;margin:auto;"> <p>尽管任意放大两个或者三个维度也是可能的，但是任意缩放需要繁琐的人工调参同时可能产生的是一个次优的精度和效率。因此EfficientNet系列提出了复合缩放 (compound scaling) 的算法, <strong>先确定基础网络</strong>，<strong>然后</strong>通过 AutoML 的方式网格搜索<strong>三个维度的缩放比例</strong>，使用者可以根据自己的需求和硬件资源，按照已经搜索到的缩放比例，<strong>使用一个复合系数Φ成倍的缩放基础网络</strong>来获得适合自己的网络。</p> <img src="https://i.ibb.co/YfTNDSV/en-compound.png" style="display:block;margin:auto;"> <p>因为卷积神经网络可以视为几个stage的组合，每个stage重复不同的次数，而每个相同的stage的重复block都有相同的结构，所以卷积神经网络的函数可以定义如下：</p> <img src="https://i.ibb.co/pX5N47z/en-compoundeq1.png" width="400" style="display:block;margin:auto;"> <ul><li><code>i</code>: stage 索引</li> <li><code>F</code>: 残差模块卷积操作</li> <li><code>X</code>: 输入</li> <li><code>L</code>: 残差模块重复次数</li> <li><code>H, W, C</code>: 高度，宽度，通道数</li></ul> <p>通过AutoML搜索超参: <code>d</code>, <code>w</code>, <code>r</code>, 在给定硬件资源的条件下，最大化精度:</p> <img src="https://i.ibb.co/0DDgMxs/en-compoundeq2.png" width="500" style="display:block;margin:auto;"> <p>其中<code>d</code>是深度缩放系数，<code>w</code>是宽度缩放系数，<code>r</code>是分辨率缩放系数。加倍深度，FLOPS也加倍，加倍宽度或分辨率，FLOPS变四倍，这里限制放大倍数的乘积约等于2，这样后续放大的时候，给定任意Φ, FLOPS总会被约束在 2^Φ。</p> <img src="https://i.ibb.co/nc4v4gH/en-compoundeq3.png" width="200" style="display:block;margin:auto;"> <p>基础网络是EfficientNet-B0时:</p> <ul><li><code>d</code>: 1,2</li> <li><code>w</code>: 1.1</li> <li><code>r</code>: 1.15</li></ul> <h2 id="efficientnet-preparation"><a href="#efficientnet-preparation" class="header-anchor">#</a> EfficientNet preparation</h2> <ul><li>create conda environment<div class="language- extra-class"><pre class="language-text"><code>conda create -n fc pip=19.1.1 cudatoolkit=10.1 cudnn=7.6.5 cupti=10.1
</code></pre></div></li> <li>install tensorflow 2.2 (tf2.2 only <a href="https://www.tensorflow.org/install/source#gpu" target="_blank" rel="noopener noreferrer">supports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> cuda 10.1)<div class="language- extra-class"><pre class="language-text"><code>pip install tensorflow==2.2.0 (gpu enabled)
# or
conda install -c conda-forge tensorflow=2.2.0 (search for tensorflow-gpu first)
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>To verify if tensorflow gpu version is installed correctly, <code>tf.config.experimental.list_physical_devices('GPU')</code> or <code>tf.test.is_gpu_available()</code></p></div></li> <li>download tensorflow models from git: <code>git clone https://github.com/tensorflow/models.git</code></li> <li>add tensorflow models to Python path as if the models were installed as packages (export for effect on every process. without export, only for current shell itself.)<div class="language- extra-class"><pre class="language-text"><code>export PYTHONPATH=$PYTHONPATH:/path/to/models
</code></pre></div></li> <li>intall all dependencies<div class="language- extra-class"><pre class="language-text"><code>pip install -r requirements.txt
</code></pre></div></li> <li>if using gpu, to <a href="https://github.com/tensorflow/tensorflow/issues/35423#issuecomment-619526781" target="_blank" rel="noopener noreferrer">solve issue of ptxas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><div class="language- extra-class"><pre class="language-text"><code>ln -s /usr/local/cuda/bin .  # or, ln -s /usr/local/cuda/bin/ptxas /storage/usr/miniconda3/envs/env_name/bin/ptxas
# to remove
unlink bin
</code></pre></div></li> <li>prepare data
<ul><li>tfds: <code>python -m tensorflow_datasets.scripts.download_and_prepare --datasets=official datasets</code></li> <li>tfrecord: <code>python imagenet_to_gcs.py --raw_data_dir=$IMAGENET_HOME --local_scratch_dir=$IMAGENET_HOME/tf_records --nogcs_upload</code></li></ul> <div class="custom-block warning"><p class="custom-block-title">folder structure</p> <p>Default:</p> <ul><li>$IMAGENET_HOME: <br> train/class1/file1;train/class2/file1; <br> validation/file1; validation/file1; synset_labels.txt (class1\n class2\n)
Modified:</li> <li>$IMAGENET_HOME: <br> train/class1/file1;train/class2/file1; <br> validation/class1/file1; validation/class2/file1;</li></ul></div></li> <li>run
<ul><li>models saved in <code>meta</code>, <code>index</code> and <code>data</code> files</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>meta for graph definition;
index for variable table;
data for variable values.</p></div> <ul><li>use tensor-board to view training statistics</li> <li>models saved in <code>.pb</code>, <code>variables</code> and <code>assets</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>.pb is similar as meta;
variables save the data;
assets save other files;</p></div> <ul><li><a href="https://zhuanlan.zhihu.com/p/113734249" target="_blank" rel="noopener noreferrer">more info<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>miscellaneous
<ul><li>check cuda version: <code>cat /usr/local/cuda/version.txt</code></li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/4/2022, 9:56:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/dl/app/MachineTranslation.html">
        Machine Translation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3fa2a2e1.js" defer></script><script src="/assets/js/2.057925ea.js" defer></script><script src="/assets/js/15.402110d9.js" defer></script>
  </body>
</html>
