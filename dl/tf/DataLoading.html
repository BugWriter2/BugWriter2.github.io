<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Data loading | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json"><link rel='canonical' href='https://bugwriter2.github.io/dl/tf/DataLoading.html'/>
    <meta name="description" content="博客">
    <meta name="google-site-verification" content="PXbr-y9acmnnEmw1zgCFEydL32xlZIf1OfFmzDFUrzI">
    <link rel="preload" href="/assets/css/0.styles.9ce6ac63.css" as="style"><link rel="preload" href="/assets/js/app.3fa2a2e1.js" as="script"><link rel="preload" href="/assets/js/2.057925ea.js" as="script"><link rel="preload" href="/assets/js/19.ac40939f.js" as="script"><link rel="prefetch" href="/assets/js/10.9a53695e.js"><link rel="prefetch" href="/assets/js/11.e6f60bd9.js"><link rel="prefetch" href="/assets/js/12.90f3d785.js"><link rel="prefetch" href="/assets/js/13.42e681ed.js"><link rel="prefetch" href="/assets/js/14.7a85d7cd.js"><link rel="prefetch" href="/assets/js/15.402110d9.js"><link rel="prefetch" href="/assets/js/16.776ab4c1.js"><link rel="prefetch" href="/assets/js/17.4af5340c.js"><link rel="prefetch" href="/assets/js/18.bd060f5e.js"><link rel="prefetch" href="/assets/js/20.ac68ccd2.js"><link rel="prefetch" href="/assets/js/21.90d4b479.js"><link rel="prefetch" href="/assets/js/22.044d8e2b.js"><link rel="prefetch" href="/assets/js/23.606676bb.js"><link rel="prefetch" href="/assets/js/24.e8a14162.js"><link rel="prefetch" href="/assets/js/25.ebdc5e35.js"><link rel="prefetch" href="/assets/js/26.efd6b8fb.js"><link rel="prefetch" href="/assets/js/27.649d5e23.js"><link rel="prefetch" href="/assets/js/28.1c7ccf18.js"><link rel="prefetch" href="/assets/js/29.f0ca98d8.js"><link rel="prefetch" href="/assets/js/3.7c0ca1fc.js"><link rel="prefetch" href="/assets/js/30.540536d8.js"><link rel="prefetch" href="/assets/js/31.3cc7b8a3.js"><link rel="prefetch" href="/assets/js/32.02879a8f.js"><link rel="prefetch" href="/assets/js/33.b1417b92.js"><link rel="prefetch" href="/assets/js/34.0b5079cd.js"><link rel="prefetch" href="/assets/js/35.2828b1d3.js"><link rel="prefetch" href="/assets/js/36.d0d0971a.js"><link rel="prefetch" href="/assets/js/37.6cc365c3.js"><link rel="prefetch" href="/assets/js/38.a184b552.js"><link rel="prefetch" href="/assets/js/39.84a689f9.js"><link rel="prefetch" href="/assets/js/4.7a06b201.js"><link rel="prefetch" href="/assets/js/40.c2d886c6.js"><link rel="prefetch" href="/assets/js/5.0de0ba0e.js"><link rel="prefetch" href="/assets/js/6.cb2a4e71.js"><link rel="prefetch" href="/assets/js/7.f7f97492.js"><link rel="prefetch" href="/assets/js/8.7c626f1f.js"><link rel="prefetch" href="/assets/js/9.b014d1e7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9ce6ac63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link router-link-active">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link router-link-active">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Applications</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/dl/Optimizer.html" class="sidebar-link">Optimizer</a></li><li><a href="/dl/Loss.html" class="sidebar-link">Loss</a></li><li><a href="/dl/Backpropagation.html" class="sidebar-link">Backpropagation</a></li><li><a href="/dl/Pytorch.html" class="sidebar-link">Pytorch</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Tensorflow</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dl/tf/EagerMode.html" class="sidebar-link">Eager mode</a></li><li><a href="/dl/tf/Checkpoint.html" class="sidebar-link">Checkpoint</a></li><li><a href="/dl/tf/Function.html" class="sidebar-link">Function</a></li><li><a href="/dl/tf/DataLoading.html" aria-current="page" class="active sidebar-link">Data loading</a></li><li><a href="/dl/tf/Keras.html" class="sidebar-link">Keras</a></li><li><a href="/dl/tf/Serving.html" class="sidebar-link">Serving</a></li><li><a href="/dl/tf/Determinism.html" class="sidebar-link">Determinism</a></li><li><a href="/dl/tf/Ops.html" class="sidebar-link">Ops</a></li><li><a href="/dl/tf/MemoryControl.html" class="sidebar-link">Memory Control</a></li><li><a href="/dl/tf/Profiler.html" class="sidebar-link">Profiler</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="data-loading"><a href="#data-loading" class="header-anchor">#</a> Data loading</h1> <p>As of tf2.3, official recommended way is using TFRecord, which pre-stores processed tensors and uses them later in data pipeline.</p> <ul><li>saves the time to generate tensors</li> <li>aggregate quite a few images in single file</li> <li>json-similar serializing mechanism, protocol buffer</li> <li>streaming, so no random access</li></ul> <div class="custom-block tip"><p class="custom-block-title">TFRecord Inspection</p> <div class="language-python extra-class"><pre class="language-python"><code>raw_dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span><span class="token string">&quot;path-to-file&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> raw_record <span class="token keyword">in</span> raw_dataset<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    example <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Example<span class="token punctuation">(</span><span class="token punctuation">)</span>
    example<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>raw_record<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span>
    <span class="token comment"># from google.protobuf.json_format import MessageToJson</span>
    <span class="token comment"># json_string = MessageToJson(tf.train.Example.FromString(example))</span>
    <span class="token comment"># json.loads(json_string)</span>
</code></pre></div></div> <p>There are other ways:</p> <ul><li><p><code>tf.keras.util.Sequence</code>: follows the loading philosophy as of pytorch.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Dataset</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
  <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
  <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre></div></li> <li><p><code>tf.data.Dataset.from_generator</code>: either writes a generator function or converts a sequence to generator. <br> <code>output_types</code> and <code>output_shapes</code> are a must</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Converts sequence to generator</span>
<span class="token keyword">def</span> <span class="token function">seq_to_dataset</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seq<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      multi_enqueuer <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>OrderedEnqueuer<span class="token punctuation">(</span>seq<span class="token punctuation">)</span>
      multi_enqueuer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
          batch_xs<span class="token punctuation">,</span> batch_ys <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>multi_enqueuer<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          batch_ys <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>batch_ys<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
          <span class="token keyword">yield</span> batch_xs<span class="token punctuation">,</span> batch_ys <span class="token comment"># if sequence, both item should be tuple instead of list</span>
  x_types <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
  x_shapes <span class="token operator">=</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span>TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">22</span>
  <span class="token comment"># some_internal_fn(input_type, shallow_type), shallow_type is from the following's output_types</span>
  <span class="token comment"># since shallow_type(output_types) only supports tuple, input_type must be tuple</span>
  <span class="token comment"># sequence object must yield tuple instead of list, structure can be nested</span>
  dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>from_generator<span class="token punctuation">(</span>generator<span class="token punctuation">,</span>
                                           output_types<span class="token operator">=</span><span class="token punctuation">(</span>x_types<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                           output_shapes<span class="token operator">=</span><span class="token punctuation">(</span>x_shapes<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> dataset
</code></pre></div></li> <li><p><code>tf.data.Dataset</code>: <code>from_x</code> is like pytorch's <code>__init__</code>, <code>map</code> is like <code>__getitem__</code>, but every operation is based on tensors. For non-tensor operations, use <code>tf.py_function</code></p> <div class="custom-block tip"><p class="custom-block-title">tf.data.Dataset.list_files vs tf.data.Dataset.from_tensor_slices</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># as of tf2.1</span>
<span class="token comment"># The file_pattern argument should be a small number of glob patterns. If your filenames have already been globbed, use Dataset.from_tensor_slices(filenames) instead, as re-globbing every filename with list_files may result in poor performance with remote storage systems.</span>
list_files<span class="token punctuation">(</span>
    file_pattern<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span>
<span class="token punctuation">)</span>

from_tensor_slices<span class="token punctuation">(</span>
    tensors
<span class="token punctuation">)</span>
</code></pre></div></div> <div class="custom-block tip"><p class="custom-block-title">tf.py_function vs tf.function</p> <p><a href="https://www.tensorflow.org/api_docs/python/tf/py_function" target="_blank" rel="noopener noreferrer">tf.py_function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> enables non-tf operations in graph mode, however, it cannot be serialized and ported. Whereas, <a href="https://tf.wiki/zh_hans/basic/tools.html#tf-function" target="_blank" rel="noopener noreferrer">tf.function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(<a href="https://www.tensorflow.org/guide/function#autograph_transformations" target="_blank" rel="noopener noreferrer">or this link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) is a utility to convert operations to graph mode and it requires tf operations.</p> <p>The output type of <code>tf.py_function</code> cannot be a nested sequence. When using a <code>tf.py_function</code> with the <code>tf.data</code> API, however, you need to create a <a href="https://stackoverflow.com/a/60368616/6845273" target="_blank" rel="noopener noreferrer">wrapper function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and you can nest the outputs in that function.</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># some code to convert x to non-tensors</span>
  <span class="token comment"># some dictionary operation, bla bla</span>
  <span class="token comment"># if this function and tf_func are instance methods, instance variable updates here takes no effect on tf_func</span>
  <span class="token comment"># as execution sequence is complex</span>
  <span class="token comment"># make sure return type is consistent with output_types in tf.py_function</span>
  <span class="token keyword">pass</span>

<span class="token comment"># merge then split again</span>
<span class="token keyword">def</span> <span class="token function">tf_func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># output_types only supports 1-d tuples or lists, without nesting</span>
  <span class="token comment"># func must return results in 1-d sequence</span>
  <span class="token comment"># final result is casted to list</span>
  result <span class="token operator">=</span> tf<span class="token punctuation">.</span>py_function<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> output_types<span class="token punctuation">)</span>
  <span class="token keyword">for</span> every_item <span class="token keyword">in</span> result<span class="token punctuation">:</span>
    <span class="token comment"># assume result is a tensor not a plain list</span>
    <span class="token comment"># To pass compile check in tf graph</span>
    <span class="token comment"># TensorFlow can't figure out the shape (it would require analyzing Python code of function body)</span>
    <span class="token comment"># You should instead give the shape manually</span>
    every_item<span class="token punctuation">.</span>set_shape<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  x <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">]</span>
  y <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token comment"># must return sequence in tuple instead of list, as map only supports tuples</span>
  <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> y
dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>tf_func<span class="token punctuation">)</span>
</code></pre></div></li></ul> <p>Note that TFRecord/tf.data.Dataset uses sequential accessing, while keras.Sequence and torch use random accessing. If use tf.data.Dataset, it is hard to resume the exact iteration in an epoch. Only some weight resumptions are supported:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;Resume an iterator is supported&quot;&quot;&quot;</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> reshuffle_each_iteration<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span> <span class="token comment"># iterator state + some dataset state</span>
ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">(</span>foo<span class="token operator">=</span>it<span class="token punctuation">)</span>
mgr <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>CheckpointManager<span class="token punctuation">(</span>ckpt<span class="token punctuation">,</span> <span class="token string">'/tmp/x'</span><span class="token punctuation">,</span> max_to_keep<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># tf.Tensor(72, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(83, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(19, shape=(), dtype=int64)</span>

mgr<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Saved to {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Saved to /tmp/x/ckpt-1</span>
<span class="token comment"># tf.Tensor(74, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(33, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(93, shape=(), dtype=int64)</span>

ckpt<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Restored from {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Restored from /tmp/x/ckpt-1</span>
<span class="token comment"># tf.Tensor(74, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(33, shape=(), dtype=int64)</span>
<span class="token comment"># tf.Tensor(93, shape=(), dtype=int64)</span>


<span class="token triple-quoted-string string">&quot;&quot;&quot;Dataset is not fully resumed&quot;&quot;&quot;</span>
ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> reshuffle_each_iteration<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">(</span>foo<span class="token operator">=</span>it<span class="token punctuation">)</span>
mgr <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>CheckpointManager<span class="token punctuation">(</span>ckpt<span class="token punctuation">,</span> <span class="token string">'/tmp/x'</span><span class="token punctuation">,</span> max_to_keep<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token builtin">enumerate</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span> <span class="token comment"># A1</span>

mgr<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token builtin">enumerate</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span> <span class="token comment"># A2</span>

ckpt<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>latest_checkpoint<span class="token punctuation">)</span>

<span class="token builtin">enumerate</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span> <span class="token comment"># A1 again instead of A2, dataset starts over</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/4/2022, 9:25:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dl/tf/Function.html" class="prev">
        Function
      </a></span> <span class="next"><a href="/dl/tf/Keras.html">
        Keras
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3fa2a2e1.js" defer></script><script src="/assets/js/2.057925ea.js" defer></script><script src="/assets/js/19.ac40939f.js" defer></script>
  </body>
</html>
