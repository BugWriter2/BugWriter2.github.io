<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Commands | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json"><link rel='canonical' href='https://bugwriter2.github.io/dc/Commands.html'/>
    <meta name="description" content="博客">
    <meta name="google-site-verification" content="PXbr-y9acmnnEmw1zgCFEydL32xlZIf1OfFmzDFUrzI">
    <link rel="preload" href="/assets/css/0.styles.9ce6ac63.css" as="style"><link rel="preload" href="/assets/js/app.3fa2a2e1.js" as="script"><link rel="preload" href="/assets/js/2.057925ea.js" as="script"><link rel="preload" href="/assets/js/6.cb2a4e71.js" as="script"><link rel="prefetch" href="/assets/js/10.9a53695e.js"><link rel="prefetch" href="/assets/js/11.e6f60bd9.js"><link rel="prefetch" href="/assets/js/12.90f3d785.js"><link rel="prefetch" href="/assets/js/13.42e681ed.js"><link rel="prefetch" href="/assets/js/14.7a85d7cd.js"><link rel="prefetch" href="/assets/js/15.402110d9.js"><link rel="prefetch" href="/assets/js/16.776ab4c1.js"><link rel="prefetch" href="/assets/js/17.4af5340c.js"><link rel="prefetch" href="/assets/js/18.bd060f5e.js"><link rel="prefetch" href="/assets/js/19.ac40939f.js"><link rel="prefetch" href="/assets/js/20.ac68ccd2.js"><link rel="prefetch" href="/assets/js/21.90d4b479.js"><link rel="prefetch" href="/assets/js/22.044d8e2b.js"><link rel="prefetch" href="/assets/js/23.606676bb.js"><link rel="prefetch" href="/assets/js/24.e8a14162.js"><link rel="prefetch" href="/assets/js/25.ebdc5e35.js"><link rel="prefetch" href="/assets/js/26.efd6b8fb.js"><link rel="prefetch" href="/assets/js/27.649d5e23.js"><link rel="prefetch" href="/assets/js/28.1c7ccf18.js"><link rel="prefetch" href="/assets/js/29.f0ca98d8.js"><link rel="prefetch" href="/assets/js/3.7c0ca1fc.js"><link rel="prefetch" href="/assets/js/30.540536d8.js"><link rel="prefetch" href="/assets/js/31.3cc7b8a3.js"><link rel="prefetch" href="/assets/js/32.02879a8f.js"><link rel="prefetch" href="/assets/js/33.b1417b92.js"><link rel="prefetch" href="/assets/js/34.0b5079cd.js"><link rel="prefetch" href="/assets/js/35.2828b1d3.js"><link rel="prefetch" href="/assets/js/36.d0d0971a.js"><link rel="prefetch" href="/assets/js/37.6cc365c3.js"><link rel="prefetch" href="/assets/js/38.a184b552.js"><link rel="prefetch" href="/assets/js/39.84a689f9.js"><link rel="prefetch" href="/assets/js/4.7a06b201.js"><link rel="prefetch" href="/assets/js/40.c2d886c6.js"><link rel="prefetch" href="/assets/js/5.0de0ba0e.js"><link rel="prefetch" href="/assets/js/7.f7f97492.js"><link rel="prefetch" href="/assets/js/8.7c626f1f.js"><link rel="prefetch" href="/assets/js/9.b014d1e7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9ce6ac63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link router-link-active">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/dv/" class="nav-link">
  Data Visualization
</a></li><li class="dropdown-item"><!----> <a href="/dl/" class="nav-link">
  Deep Learning
</a></li><li class="dropdown-item"><!----> <a href="/dc/" class="nav-link router-link-active">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/qa/" class="nav-link">
  Q&amp;A
</a></li><li class="dropdown-item"><!----> <a href="/svc/" class="nav-link">
  Backend Services
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/bugwriter2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/dc/Commands.html" aria-current="page" class="active sidebar-link">Commands</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dc/Commands.html#login" class="sidebar-link">login</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#list" class="sidebar-link">list</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#rm" class="sidebar-link">rm</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#build" class="sidebar-link">build</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#tag" class="sidebar-link">tag</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#run" class="sidebar-link">run</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#docker-compose" class="sidebar-link">docker-compose</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#tf-serving" class="sidebar-link">tf serving</a></li><li class="sidebar-sub-header"><a href="/dc/Commands.html#tg-bot" class="sidebar-link">tg bot</a></li></ul></li><li><a href="/dc/Dockerfile.html" class="sidebar-link">Dockerfile</a></li><li><a href="/dc/Kubernetes.html" class="sidebar-link">Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commands"><a href="#commands" class="header-anchor">#</a> Commands</h1> <h2 id="login"><a href="#login" class="header-anchor">#</a> login</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>docker login -u _json_key -p <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> gcr-json-key-file.json<span class="token variable">)</span></span>&quot;</span> https://gcr.io
</code></pre></div><h2 id="list"><a href="#list" class="header-anchor">#</a> list</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">ps</span>
docker <span class="token function">ps</span> -a  <span class="token comment"># including stopped</span>
docker <span class="token function">ps</span> -a -q <span class="token comment"># all processes(containers)' id</span>
docker container <span class="token function">ls</span>
docker container <span class="token function">ls</span> -a <span class="token comment"># including stopped</span>
</code></pre></div><h2 id="rm"><a href="#rm" class="header-anchor">#</a> rm</h2> <ol><li>remove container + image<div class="language-bash extra-class"><pre class="language-bash"><code>docker container stop name_or_id
docker container <span class="token function">rm</span> name_or_id
docker image <span class="token function">rm</span> name_or_id
</code></pre></div></li> <li>remove all containers<div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker <span class="token function">ps</span> -a -q<span class="token variable">)</span></span>
</code></pre></div></li> <li><code>rm</code> vs <code>rmi</code>
images size listed in <code>docker images</code> is cumulated with parent size. If parent is pre-built separately at local machine, remove the image might not release the total size listed. To check actual released size, calculate the difference between the two commands <code>docker system df</code>. To check each layer size, <code>docker history &lt;img&gt;</code> <blockquote><p><code>rm</code> is for container <br> <code>rmi</code> is for image</p></blockquote></li> <li>Remove all dangling(not referring to any tagged images) images. If <code>-a</code> is specified, will also remove all images not referenced by any container.
<blockquote><p><code>docker image prune</code></p></blockquote></li></ol> <h2 id="build"><a href="#build" class="header-anchor">#</a> build</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>docker build -t tag -f Dockerfile <span class="token builtin class-name">.</span>
</code></pre></div><blockquote><p><code>.</code> project context</p></blockquote> <h2 id="tag"><a href="#tag" class="header-anchor">#</a> tag</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>docker tag image:v1 image:v2
docker push image:v2
</code></pre></div><h2 id="run"><a href="#run" class="header-anchor">#</a> run</h2> <ol><li><p><code>run</code>
simple command</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run some_image <span class="token function">ls</span>
</code></pre></div><ul><li><code>ls</code>: the command to run in the container. After it exits, the container stops.</li></ul> <p>interactive command like <code>/bin/bash</code> or <code>python</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -ti some_image /bin/bash
</code></pre></div><ul><li><code>-ti</code> <ul><li><code>-t</code> into the container. Interactive commands must have it.</li> <li><code>-i</code> with STDIN pass to the container. Only effective with <code>-t</code></li> <li>If only <code>-t</code>, a bash shell is created but user input is not passed to it.</li> <li>If only <code>-i</code>, no effect</li></ul></li> <li><code>/bin/bash</code>: the command to run in the container. After it exits, the container stops.</li> <li><code>ctrl+p ctl+q</code>: if <code>-ti</code>, detach the running docker to background. <code>docker attach name_of_the_container</code> will resume it.</li> <li><code>ctrl+d</code>: if <code>-ti</code>, will exist the bash in container, stop the container and come back to the terminal.</li></ul> <p>port-forwarding</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p <span class="token number">8000</span>:8080 --rm -it --name apple image_tag
</code></pre></div><ul><li><code>-p/--publish 8000:8080:</code> asks Docker to forward traffic incoming on the host’s port 8000, to the container’s port 8080</li> <li><code>--rm</code>: once stopped, removed the containers</li> <li><code>-t</code>: into the container</li> <li><code>-i</code>: with STDIN</li> <li><code>--name</code>: give it a name</li></ul> <blockquote><p>Containers are merely an instance of the image you use to run them; <code>docker run</code> will create a temporary container and execute the command. After command finishes, the container is also stopped</p></blockquote></li> <li><p><code>exec</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> apple
docker <span class="token builtin class-name">exec</span> <span class="token function">id</span>
docker <span class="token builtin class-name">exec</span> -t -i mycontainer /bin/bash
</code></pre></div><blockquote><p>run commands on the <strong>running</strong> container</p></blockquote></li> <li><p><code>top</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">top</span> apple
docker <span class="token function">top</span> <span class="token function">id</span>
</code></pre></div><blockquote><p>see processes</p></blockquote></li></ol> <h2 id="docker-compose"><a href="#docker-compose" class="header-anchor">#</a> docker-compose</h2> <p><code>docker-compose start name</code>: start a service</p> <p><code>docker-compose up -d name</code>: start this service and any binding ones</p> <p><code>docker-compose run --service-ports name [NEW COMMAND]</code>: start service with new command and with port-forwarding</p> <h2 id="tf-serving"><a href="#tf-serving" class="header-anchor">#</a> tf serving</h2> <p>check serving status: localhost:8501/v1/models/model_name</p> <p>check serving schema: localhost:8501/v1/models/model_name/metadata</p> <ol><li><p>way 1</p> <p>gRPC</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p <span class="token number">8500</span>:8500 <span class="token punctuation">\</span>
--mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/tmp/mnist,target<span class="token operator">=</span>/models/mnist <span class="token punctuation">\</span>
-e <span class="token assign-left variable">MODEL_NAME</span><span class="token operator">=</span>mnist -t tensorflow/serving <span class="token operator">&amp;</span>
</code></pre></div><p>rest api</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -p <span class="token number">8501</span>:8501 <span class="token punctuation">\</span>
--mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/tmp/mnist,target<span class="token operator">=</span>/models/mnist <span class="token punctuation">\</span>
-e <span class="token assign-left variable">MODEL_NAME</span><span class="token operator">=</span>mnist -t tensorflow/serving <span class="token operator">&amp;</span>
</code></pre></div><p>bash parameters:</p> <ul><li><code>&amp;</code> as long as the container does not output logs, it will <a href="https://unix.stackexchange.com/a/86253" target="_blank" rel="noopener noreferrer">run in the background<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Otherwise, the terminal is occupied.
<ul><li><code>jobs</code> will list background jobs</li> <li><code>fg</code> will take a background job in the front</li> <li>use docker parameter <code>-d -ti</code> is better.</li></ul></li></ul> <p>docker parameters:</p> <ul><li><code>--mount type=bind,source=x,target=y</code>: creates a folder y in the container, and x,y must be absolute paths</li> <li><code>models/mnist</code> contains version folder <code>1</code></li> <li><code>-e MODEL_NAME</code> must equal target, if no <code>-e MODEL_BASE_PATH</code></li> <li><code>-e MODEL_NAME</code>, equals <code>--model_name</code>, <code>--MODEL_NAME</code> in tf serving parameters</li> <li><code>-e TF_CPP_MIN_VLOG_LEVEL=4</code> enables verbose logging of tf serving, and it logs continuously thus occupies the terminal even if <code>&amp;</code> <ul><li><code>TF_CPP_MIN_LOG_LEVEL</code>: controls <code>LOG</code> with format <code>[module] msg</code>; 0 logs everything, 4 logs nothing</li> <li><code>TF_CPP_MIN_VLOG_LEVEL</code>: controls <code>VLOB</code> with format <code>[time level file] msg</code>; extra info per allowed <code>LOG</code> level; 0 logs nothing, 4 logs everything</li> <li><code>TF_CPP_MIN_VLOG_LEVEL</code> has been renamed to <code>TF_CPP_MAX_VLOG_LEVEL</code> after 2.5.0rc0</li></ul></li> <li><code>-e TF_FORCE_GPU_ALLOW_GROWTH=true</code>: occupies gpu mem step by step</li> <li><code>--gpus '&quot;device=2&quot;'</code> (requires nvidia-docker and docker &gt;= 19.03, for lower version of docker, use <code>--runtime=nvidia</code>)</li></ul> <p>tf serving parameters, must adds after image name:</p> <ul><li><code>--enable_batching</code>: adds after image name to batch the requests</li></ul></li> <li><p>way 2</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">TESTDATA</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/models/model_name/&quot;</span>

docker run -t --rm -p <span class="token number">8501</span>:8501 <span class="token punctuation">\</span>
-v <span class="token string">&quot;<span class="token variable">$TESTDATA</span>:/models/keras_dpr_model&quot;</span> <span class="token punctuation">\</span>
-e <span class="token assign-left variable">MODEL_NAME</span><span class="token operator">=</span>keras_dpr_model <span class="token punctuation">\</span>
tensorflow/serving <span class="token operator">&amp;</span>
</code></pre></div><ul><li><code>-v</code>: creates a folder in the container</li></ul></li> <li><p>way 3</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d --name serving_base tensorflow/serving

docker <span class="token function">cp</span> /tmp/resnet serving_base:/models/resnet

docker commit --change <span class="token string">&quot;ENV MODEL_NAME resnet&quot;</span> serving_base <span class="token environment constant">$USER</span>/new_image

docker <span class="token function">kill</span> serving_base
docker <span class="token function">rm</span> serving_base

docker run -p <span class="token number">8500</span>:8500 -t <span class="token environment constant">$USER</span>/new_image <span class="token operator">&amp;</span>
</code></pre></div><ul><li><code>-d</code>: detach</li></ul></li></ol> <h2 id="tg-bot"><a href="#tg-bot" class="header-anchor">#</a> tg bot</h2> <p>In google cloud:</p> <ul><li>Update environment variables in <code>.env</code> and <code>run.sh</code></li> <li>If session expired: <code>python main.py</code></li> <li><code>sudo sysctl -w vm.max_map_count=262144</code> for elastic search to work</li> <li><code>sudo docker-compose up -d</code> to start</li> <li>To index history messages: <code>/download_history</code></li> <li><code>sudo docker-compose down</code> to stop</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/25/2022, 10:19:39 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/dc/Dockerfile.html">
        Dockerfile
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3fa2a2e1.js" defer></script><script src="/assets/js/2.057925ea.js" defer></script><script src="/assets/js/6.cb2a4e71.js" defer></script>
  </body>
</html>
